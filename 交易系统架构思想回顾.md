DTP

MDD设计，编码，部署等阶段的全周期统一化采用，支持模型接口定义更新管理，支持代码模块生成能力，支持版本控制和溯源
设计领域：元数据类型定义，业务数据模型，业务消息模型，错误信息模型等定义
推荐： 基于模型定义代码生成的开源工具链(模板+数据模型=输出)

用例设计和关联设计:

架构工作清单


Dimple, DTP


时间与事件

人机接入让位于机器交易



* 交易系统时间观事件
   * 现代交易系统处于一个跨区域，时区，分布式IT始终环境
   * 物理世界的事件概念被运用于交易时段，交易规则，交易行为限制等方面，甚至包括交易日
   * 时钟同步的必要性和局限性
* 应对策略
   * 宽进严出 系统状态机 权限控制 流控
   * 时间为表象 事件为实质
   * 排队机/授时器/定序器
* 核心概念: 事件
   * 事件概念的唯一性和可追溯性
   * 事件的表达定义, ts, no, type, name, source, desination, cause/effect
   * 前置事件，后置事件，并行事件，事件嵌套，循环事件，操作事件，状态事件，数据事件，失败事件，故障事件
   * 定时器运用，交易日/自然日的嫁接价值
* 传统的物理时间概念能否被新的事件模型所取代


为什么是流

!= mq, 没有发布者订阅者的说法，不是必须的概念
主题队列是mq概念，在流里面不会突出主题和队列

业务基于流来实现
流是自然的自己本来的体系

这个概念有历史，即使之前不这么提，核心原理结构思想20年没变过

上海交易所二代行情，下游衔接

国内撮合竞价普遍认同流的概念
证券银行少一点

* 多维分析
   * 交互模型角度: 人机交互 ==> 自动化交易
   * 数据模型角度：关系型数据模型 ==> 基于事件/事件消息/指令模型
   * 系统模型角度: 多层次多功能模块化系统结构 ==> 面像消息流的分布式系统结构
* 消息协议分析
   * 请求/应答，轮询，广播/多播，推送，可靠推送
   * 有序/持续化，单调递增，对象化消息，发布/订阅
   * 接口契约化，违规风险巨大切不可空
* 交融交易世界里的六模型事件观，方法论
   * 交易流（会话流），私有流(会员流)，功有流（市场流)
   * FTD, FIX, STEP, FAST
* 目前新时代交易系统对流的理解和运用
   * 从消息交互模型转变为消息/数据服务模型
   * 流实质是消息数据模型，可靠推送是最佳实践之一
* extension: 帝国主义的fix和开放世界的API

数学本质论

Actor, mailbox, reactive

```
MailBox <-----------------------Actor
  |                               ^
  |                      +--------+
  v                     /
Actor -------------> mailbox <------------+
 |                                         \
 |                                          \
 +-----------------> mailbox ---> Actor -----+
```

要求在处理环节要求无IO, 去掉IO, 内存式计算模块，CPU bound 

只有对外输出就是所谓IO, 带网卡，磁盘，
CPU到内存认为不是IO

Actor里面简单粗暴，串行，没有并行，Actor里多线程处理也是可以，CPU或内存处理只要有冲突是有性能损耗的。

开发商在研究，能不能在Actor里面，再提升，流水线结构，


rector model 在数学上也是有定义的，函数，封闭性函数，
不因外因而产生结果变动，输入什么，输出一定是稳定的

满足这样的计算模式的叫容错模块
容错就是搞冗余，一样的输入，有一样的输出

容错不是性能，容错需要有数学依据



三层架构： IO层，数据库优化，并发模型，要锁，冲突模型

Dimple： 核心，前置，报盘


交易模型大部分是写事务

* 核心模型的数学公式 {Ti, Oi} = F(Ti-1, Ii)
   * F系统模块代码控件, T系统模块数据空间，i事件
   * I模块输入事件/消息 (stream), O module output event/message (stream)
   * system reference model: Single-Actor-Model + MQ(HA)
* 数学约束下导致对IT系统环境限制的控制
   * 随机数，模拟
   * 机器时钟，IT现场环境数据
   * 乱序，优先级
* 数学优势下赋予的系统高级能力
   * Relay (保证流一致性, replay/playback, 现场恢复)
   * Failover (容错，多活，热别，零切换)
* extension: Multi-Actor-Model + MQ(HA) + ES + SAGA

一致性的成败

时钟
* timestamp
* logic clock, unified clock , vector clock
参考模型
* weak , strong consistency
* 顺序一致性，因果
* 最终，流一致性
* 算法，paxos, raft, zab

理论
* RWN: R + W > N
* ACID, data replia, CAP, BASE

CQRS是完美解决一致性的出路吗？
和微服务架构没什么关系，
建议学习学习
CQRS 能提供command, query分离，能容错

如何实践CQRS
Command用C++写的，指令代码，用C的内存里做
查询也是用C++写的，用的是内存数据库

数据同质的，

思想可以类似，实现谁厉害拼技术栈，中间件

对于DTP来讲，可以实现好的模型

大部分金融系统，高可用标准都很高，
核心系统：
* 数据0丢失
* 无单点
* 有冗余能自动切换
*
一致性概念比HA还复杂

二进制的优势和尴尬

二进制浮点数的分析分层:
* 存储: DB， File, Process(无损)
* 运算 精度控制
* 通信 尺寸，转换
* UI

再金融里所有数据要10进制计算，就是算账，算持仓
费率，保证金，余额
四舍五入，小数点进度问题

金融领域的十进制数值使用要求，还是4舍五入
数据库提供的是10进制计算模式，和金融要求匹配

但现在用程序写，

主流金融商用标准IT系统中二进制数值的运用标准:
* 金融交易 二进制偏好
* 结算支付(会计) 十进制偏好
* 金融工程 科学性偏好

extension: 十进制数值类型decimal是终极手段吗


快，够快吗

* TPS 每秒交易指令数
* LAT 指定p2p端的消息延迟
* 分布式系统和并发访问模式下， TPS和LAT没有直接的严格数学关系

分布式下不谈吞吐量，谈延迟，机器和机器交互多了

LAT决定了目标系统对关键指令的反馈能力
- 柜台（主席）系统, 期望TPS优势，同时兼具LAT优势
- 二席 (极速) 更期望LAT优势

TPS于LAT在系统能力方面的矛盾性和相互促进

API交易接入方案